<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Gugrontid map</title>
    <style>
     html, body {
       width:  100%;
       height: 100%;
       margin: 0px;
     }
    </style>
  </head>

  <body>
    <canvas id="map_canvas"></canvas>

    <script>
     /**
      * Loads map image to canvas and place markers.
      */

     //The categories of the markers
     var m_categories = {
       characters: {
         name: "Characters",
         description: "NPCs like monsters, quest givers, trainers, traders etc.",
         def_image: "char.gif"
       },
       crafting_places: {
         name: "Crafting places"
       },
       mining_places: {
         name: "Mining places",
         def_image: "gather.gif"
       }
     };

     //This array contains positions of markers
     var markers = [{
       name: "Guy Dudesson",
       location: [32, 135],
       category: 'characters'
     }, {
       name: "Troll Lolo",
       location: [133, 337],
       category: 'characters'
     }, {
       name: "Parker Peters",
       location: [400, 23],
       category: 'characters'
     }, {
       name: "Mr. X",
       location: [532, 123],
       category: 'characters'
     }, {

       image: "craft.gif",
       name: "Work bench",
       location: [[200, 200], [200, 300], [450, 129]],
       category: 'crafting_places'
     }, {
       image: "craft.gif",
       name: "Sock maker",
       location: [232, 312],
       category: 'crafting_places'
     }, {
       image: "craft.gif",
       name: "Fire bender",
       location: [275, 200],
       category: 'crafting_places'
     }, {

       name: "Gold",
       location: [[321, 123], [32, 400]],
       category: 'mining_places'
     }, {
       name: "Silver",
       location: [666, 432],
       category: 'mining_places'
     }, {
       name: "Diamonds",
       location: [311, 164],
       category: 'mining_places'
     }];

     //Custom user settings
     //Hidden map markers
     var hidden_categories = ['characters'];
     var hidden_markers = [];

     //Static settings
     //Where to find position 0, 0 in the world
     var COORD_X = 0;
     var COORD_Y = 0;
     var SCALE = 50; //How far is 100 steps is on the map
     //Map image
     var mapimg = 'gugrontid.jpg';

     /***/

     var c = document.getElementById("map_canvas");
     var ctx = c.getContext("2d");

     //Load the map
     var mapObj = new Image();

     mapObj.onload = function() {
       setInterval(function() {
         draw();
       }, 200);
     };

     mapObj.src = mapimg;

     var drawables = [];
     var imageMap = []; //Stores images for reuse

     //Store every marker by a unique key 'name', often similar to the name attribute
     var name_indexed_markers = {};

     //Put the markers in the draw array
     for(var i = 0; i < markers.length; i++) {
       //Fuse togheter the spaces to create the name
       markers[i].indexName = markers[i].name.replace(/\s+/g, '_');
       //Remove special characters
       markers[i].indexName = markers[i].indexName.replace(/\.+/g, '');
       markers[i].indexName = markers[i].indexName.toLowerCase();

       //Are there already one such name? Then add a number to it
       if(name_indexed_markers[markers[i].indexName] != null) {
         markers[i].indexName += name_indexed_markers.length;
       }

       //Put the marker in the index array
       name_indexed_markers[markers[i].indexName] = markers[i];

       //Location means there are something to put in drawables
       //Location could be an array, be aware!
       var locations = markers[i].location;

       //Since location stores the value in format [x, y]
       //it is needed to warp it in an array so the single positions do not got looped through
       if(!Array.isArray(markers[i].location[0])) {
         locations = [markers[i].location];
       }

       //Do the marker have an image, else fetch a default one
       if(markers[i].image == null) {
         markers[i].image = m_categories[markers[i].category].def_image;
       }

       var icoObj = null;

       //See if there are a reusable image available
       for(var i = 0; i < imageMap.length; i++) {
         if(imageMap[i].src == markers[i].image) {
           icoObj = imageMap[i];
           break;
         }
       }

       //Store the image for future use
       if(icoObj == null) {
         icoObj = new Image();

         icoObj.src = markers[i].image;

         imageMap.push(icoObj);
       }

       //Put every location in the drawable array
       for(var j = 0; j < locations.length; j++) {
           drawables.push({
             indexName: markers[i].indexName, 
             image: icoObj,
             x: locations[j][0],
             y: locations[j][1]
           });
       }
     }

     //Calculate scale
     var scale = SCALE / 100;

     /***/

     /**
      * Draw loop, update map whe resized
      */
     function draw() {
       ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

       ctx.canvas.width  = window.innerWidth;
       ctx.canvas.height = window.innerHeight;

       //Scale the map to the screen
       var ih = mapObj.height;
       var iw = mapObj.width;

       //The map should retain its aspect ratio
       var aspect_ratio = iw / ih;

       var nh = ctx.canvas.height;
       var nw = nh * aspect_ratio;
       var nx = (ctx.canvas.width - nw) / 2;
       var ny = 0;
       
       if(nw > ctx.canvas.width) {
         nw = ctx.canvas.width;
         nh = nw / aspect_ratio;
         ny = (ctx.canvas.height - nh) / 2;
         nx = 0
       }

       ctx.drawImage(mapObj, nx, ny, nw, nh);

       //Markers
       //Calculate scaling offset for markers
       var scalex = (nw / iw);
       var scaley = (nh / ih);

       //Draw the markers
       for(var i = 0; i < drawables.length; i++) {
         ctx.drawImage(
           drawables[i].image, 
           drawables[i].x * scalex + nx,
           drawables[i].y * scaley + ny);
       }
     }
    </script>
  </body>
</html> 
